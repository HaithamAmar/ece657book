# `epub_builder/`

Standalone (Pandoc-based) EPUB builder project for the LaTeX sources in `notes_output/`.

This folder is intentionally self-contained: all build code and build artifacts live under `epub_builder/` to avoid polluting `notes_output/`.

## Requirements (macOS)

- `pandoc`
- `pdflatex`
- `pdftoppm` (Poppler) or equivalent PDF→PNG tool
- (Optional) `epubcheck`
- (Optional, for screenshots) `python3` + Playwright

## Usage

From the repo root:

```bash
python3 epub_builder/build.py --variant apple
python3 epub_builder/build.py --variant kindle
python3 epub_builder/build.py --variant both
```

Optional quality knobs:

```bash
# Increase TikZ rasterization quality (bigger EPUBs, slower clean builds).
python3 epub_builder/build.py --variant both --tikz-dpi 350

# Faster iteration: keep transient build outputs.
python3 epub_builder/build.py --variant both --no-clean
```

Outputs:
- `epub_builder/dist/ece657_ebook_apple.epub`
- `epub_builder/dist/ece657_ebook_kindle.epub`

Artifacts/logs:
- `epub_builder/artifacts/`

## Visible numbering and figure guarantees

This project treats the EPUB as a publishable artifact, so it makes some numbers
visible (many EPUB readers do not expose LaTeX-style numbering by default).

- **Chapters:** `\section{...}\label{chap:...}` becomes `Chapter N: ...` using `notes_output/ece657_notes.aux`.
- **Sections:** labeled `\subsection{...}\label{sec:...}` / `\subsubsection{...}\label{...}` are prefixed with their `.aux` number (e.g., `1.3 ...`).
- **Figures/Tables:** captions are prefixed as `Figure N.` / `Table N.` using `.aux` data.
- **Equations:** MathML has no equation numbers, so the builder adds a small right-aligned visible number line `(N)` after each labeled display equation environment, and equation refs are rewritten to link to those targets.

The builder also enforces “no caption-only figures”:

- Unwraps common graphics wrappers (e.g., `\resizebox{...}{...}{\includegraphics{...}}`) into a plain `\includegraphics{...}` so Pandoc reliably emits `<img>`.
- Strips `\captionsetup{...}` directives (ignored by Pandoc and often adjacent to those wrappers).
- Runs in **strict figure mode** by default:
  - TikZ compilation failures abort the build.
  - Missing `\includegraphics{...}` targets abort the build.
  - The produced EPUB is checked to ensure referenced `<img src=...>` files exist in the zip.

## Notes (why the builder rewrites references)

- **Chapters/Figures/Tables:** Pandoc can resolve `\\ref{...}` to numbered links when it can infer the target structure, but it does not add prefixes. The builder rewrites chapter/figure/table references so the visible text includes `Chapter`, `Figure`, or `Table`.
- **Equations:** Pandoc often preserves `\\label{eq:...}` inside MathML annotations instead of emitting an HTML anchor. The builder injects explicit anchors for equation labels and rewrites `\\eqref{...}`/`\\Cref{eq:...}` into links with the correct equation number.
- **Where equation numbers come from:** the builder reads `notes_output/ece657_notes.aux` if present (generated by the PDF build). If the `.aux` file is missing, equation links still work but the displayed number may be `?`.

## Notes (TikZ rendering)

- TikZ/pgfplots figures are extracted and rendered to PNGs via `pdflatex` + `pdftoppm`.
- The standalone TikZ preamble includes the book’s common color palette and initializes a `background` layer; this is required for figures that use `show background rectangle` and similar constructs.
- If a TikZ block fails to compile, it will remain as raw LaTeX and may not render in EPUB; check `epub_builder/artifacts/tikz_logs/` for failures.

## Visual QA (screenshots)

- Install once:
  - `python3 -m venv epub_builder/.venv`
  - `epub_builder/.venv/bin/pip install playwright`
  - `epub_builder/.venv/bin/python -m playwright install chromium`
- Render quick screenshots from the built EPUB (unpacks and captures selected chapter XHTML files):
  - `epub_builder/.venv/bin/python epub_builder/scripts/render_epub_screenshots.py --epub epub_builder/dist/ece657_ebook_apple.epub --out epub_builder/artifacts/screenshots/apple --count 12`
- Still do final manual QA in real readers:
  - Apple Books app (macOS)
  - Kindle Previewer (macOS)
